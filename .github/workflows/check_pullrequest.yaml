name: Check pull request

on:
  push:
  pull_request:
    branches: [ main ]

jobs:
  Build:
    name: Build ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Get last vscode release
        id: vscode_last_release
        shell: bash
        run: |
          echo "vscode_version=`curl --silent https://update.code.visualstudio.com/api/releases/stable | jq -r '.[0]'`" >> $GITHUB_OUTPUT

      - uses: actions/cache@v4
        with:
          path: .vscode-test
          key: vscode-test_${{ runner.os }}_${{ steps.vscode_last_release.outputs.vscode_version }}

      - uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}

      - name: Configure environment
        if: ${{ matrix.os == 'ubuntu-latest' }}
        run: |
          /usr/bin/Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          echo ">>> Started xvfb"

      - name: List global
        run: npm list -g

      - name: Install vsce
        run: npm install -g @vscode/vsce

      - name: Install
        run: npm i

      - name: Test
        run: npm run test

      # - run: npm i
      # - run: npm run test
      # - run: npm run coverage
      # - run: npm run compile